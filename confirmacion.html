<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmaci√≥n | Yoseba & Ana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .btn-reject {
      background-color: #f8f9fa;
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    .btn-reject:hover {
      background-color: #dc3545;
      color: white;
    }
    /* Estilo para que el bot√≥n confirmar sea verde por defecto */
    #btnConfirmar {
      background-color: #7a8a76 !important;
      border-color: #7a8a76 !important;
      color: white !important;
    }
  </style>
</head>
<body>

<nav class="centered-nav fixed-top">
  <div class="container text-center">
    <a class="nav-brand-title d-block" href="index.html">Yoseba & Ana</a>
    <ul class="nav-links list-unstyled d-flex justify-content-center border-top">
      <li class="nav-item"><a class="nav-link nav-box" href="index.html">¬°Bienvenidos!</a></li>
      <li class="nav-item"><a class="nav-link nav-box" href="itinerario.html">El Gran D√≠a</a></li>
      <li class="nav-item"><a class="nav-link nav-box active" href="confirmacion.html">Confirmaci√≥n</a></li>
      <li class="nav-item"><a class="nav-link nav-box" href="fotos.html">√Ålbum</a></li>
      <li class="nav-item"><a class="nav-link nav-box" href="agradecimiento.html">Agradecimiento</a></li>
      <li class="nav-item"><a class="nav-link nav-box" href="novedades.html">√öltimas Novedades</a></li>
      <li class="nav-item"><a class="nav-link nav-box" href="#contacto">Contacto</a></li>
    </ul>
  </div>
</nav>

<div class="container mt-5 pt-5"> 
  <h1 class="text-center mb-4">CONFIRMACI√ìN</h1>

  <div class="content-panel mx-auto" style="max-width: 1000px;">
    <p class="text-center">
      Para confirmar tu asistencia a la boda solo tienes que escribir tu nombre y elegirlo en la lista.
      Si lamentablemente no puedes venir, pulsa el bot√≥n <strong>"No podr√© asistir"</strong> para que podamos tenerlo en cuenta.
    </p>
  </div>

  <div id="formConfirmacion" class="mx-auto custom-form-box mb-5 shadow-sm" style="max-width:500px;">
    <label class="form-label small fw-bold">1. Escribe tu nombre</label>
    <div class="position-relative mb-3">
        <input type="text" id="buscadorNombre" class="form-control" placeholder="Escribe tu nombre" autocomplete="off">
        <ul id="listaSugerencias" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></ul>
        <input type="hidden" id="nombreReal" required>
    </div>

    <label class="form-label small fw-bold">2. Tel√©fono m√≥vil</label>
    <input type="tel" id="telefono" class="form-control mb-3" 
       placeholder="Ej: 600000000" pattern="[0-9]{9}" maxlength="9" required>

    <div class="mb-3 mt-4">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="checkAlergia">
        <label class="form-check-label fw-bold small" for="checkAlergia">¬øTienes alguna alergia o intolerancia?</label>
      </div>
    </div>

    <div id="panelAlergia" style="display: none;" class="mb-3">
      <label class="form-label small fw-bold">Indica cu√°l o cu√°les:</label>
      <textarea id="alergiaDetalle" class="form-control" rows="2" placeholder="Ej: Frutos secos, cel√≠aco..."></textarea>
    </div>

    <label class="form-label small fw-bold">4. Dedicatoria (opcional)</label>
    <textarea id="mensaje" class="form-control mb-3" rows="3" placeholder="Escribe algo para los novios..."></textarea>

    <div class="row g-2">
      <div class="col-md-7">
        <button type="button" id="btnConfirmar" class="btn btn-primary w-100 py-2">Confirmar asistencia</button>
      </div>
      <div class="col-md-5">
        <button type="button" id="btnNegar" class="btn btn-reject w-100 py-2">No podr√© asistir</button>
      </div>
    </div>
  </div>
</div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbwmUjlmobaJmXqRBNQYarQRcXto0emCx-llHlnuB40GWL1iajPOwonV5e_4KUe4fHqg/exec'; 
  let invitados = [];

  // Mostrar/Ocultar panel de alergias
  document.getElementById('checkAlergia').addEventListener('change', function(e) {
    document.getElementById('panelAlergia').style.display = e.target.checked ? 'block' : 'none';
  });

  const buscador = document.getElementById('buscadorNombre');
  const listaSugerencias = document.getElementById('listaSugerencias');
  const nombreReal = document.getElementById('nombreReal');

  // Cargar lista de invitados al inicio
  window.addEventListener('DOMContentLoaded', () => {
    fetch(scriptURL)
      .then(res => res.json())
      .then(data => { invitados = data; })
      .catch(err => console.error("Error cargando invitados", err));
  });

  // Buscador de nombres
  buscador.addEventListener('input', (e) => {
    const texto = e.target.value.toLowerCase().trim();
    listaSugerencias.innerHTML = '';
    if (texto.length < 2) { listaSugerencias.style.display = 'none'; return; }

    const coincidencias = invitados.filter(i => 
      i.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(texto)
    );

    if (coincidencias.length > 0) {
      coincidencias.forEach(i => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.style.cursor = 'pointer';
        li.textContent = i.nombre;
        li.onclick = () => {
          buscador.value = i.nombre;
          nombreReal.value = i.nombre;
          listaSugerencias.style.display = 'none';
        };
        listaSugerencias.appendChild(li);
      });
      listaSugerencias.style.display = 'block';
    } else {
      listaSugerencias.style.display = 'none';
    }
  });

  document.addEventListener('click', (e) => {
    if (e.target !== buscador) listaSugerencias.style.display = 'none';
  });

  // Funci√≥n de env√≠o corregida
  function enviar(asistencia) {
    const nombre = nombreReal.value;
    const telefono = document.getElementById('telefono').value;
    const esAlergico = document.getElementById('checkAlergia').checked ? "S√ç" : "NO";
    const detalleAlergia = document.getElementById('alergiaDetalle').value;
    const msg = document.getElementById('mensaje').value;

    if (!nombre) { alert("Por favor, selecciona tu nombre de la lista."); return; }
    if (telefono.length < 9) { alert("Introduce un tel√©fono v√°lido de 9 cifras."); return; }

    const btnC = document.getElementById('btnConfirmar');
    const btnN = document.getElementById('btnNegar');
    btnC.disabled = btnN.disabled = true;
    btnC.textContent = "Enviando...";

    // Env√≠o mediante URLSearchParams para mayor compatibilidad
    const params = new URLSearchParams({
      nombre: nombre,
      telefono: telefono,
      mensaje: msg,
      asistencia: asistencia,
      alergico: esAlergico,
      alergiaDetalle: detalleAlergia
    });

    fetch(scriptURL + '?' + params.toString(), { method: 'POST' })
      .then(() => {
        alert(asistencia === 'S√ç' ? '¬°Confirmado! Nos vemos pronto.' : 'Entendido, te echaremos de menos.');
        location.reload();
      })
      .catch((err) => {
        console.error(err);
        // A veces Google da error de red pero el dato entra, recargamos igual
        alert("Respuesta enviada correctamente.");
        location.reload();
      });
  }

  document.getElementById('btnConfirmar').onclick = () => enviar('S√ç');
  document.getElementById('btnNegar').onclick = () => enviar('NEGADO');
</script>

<footer id="contacto" class="py-4 border-top">
  <div class="container text-center">
    <div class="small text-muted mb-2">¬© 2026 Yoseba & Ana</div>
    <div class="small text-muted">anacarmonacordoba@gmail.com | üì± 692 260 215</div>
    <div class="small text-muted">garciapardoyoseba@gmail.com | üì± 611 459 193</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>