<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmaci贸n | Yoseba & Ana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .btn-reject {
      background-color: #f8f9fa;
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    .btn-reject:hover {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>

<nav class="centered-nav fixed-top">
  <div class="container text-center">
    <a class="nav-brand-title d-block" href="index.html">Yoseba & Ana</a>
    
    <ul class="nav-links list-unstyled d-flex justify-content-center border-top">
      <li class="nav-item">
        <a class="nav-link nav-box" href="index.html">隆Bienvenidos!</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box" href="itinerario.html">El Gran D铆a</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box active" href="confirmacion.html">Confirmaci贸n</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box" href="fotos.html">lbum</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box" href="agradecimiento.html">Agradecimiento</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box" href="novedades.html">ltimas Novedades</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-box" href="#contacto">Contacto</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container mt-5 pt-5"> 
  <h1 class="text-center mb-4">Confirmaci贸n de asistencia</h1>

  <div class="content-panel mx-auto" style="max-width: 1000px;">
    <p class="text-center">
      Para confirmar tu asistencia a la boda s贸lo tienes que indicar lo que te une a nosotros, seleccionar tu nombre en la lista y rellenar tu tel茅fono. 
      Si lamentablemente no puedes venir, pulsa el bot贸n <strong>"No podr茅 asistir"</strong> para que podamos tenerlo en cuenta.
    </p>
  </div>

  <form id="formConfirmacion" class="mx-auto custom-form-box mb-5 shadow-sm" style="max-width:500px;">
    <label class="form-label small fw-bold">1. Selecciona tu grupo</label>
    <select id="grupo" class="form-select mb-3" required>
      <option value="">Selecciona tu grupo...</option>
      <option>Familia Ana</option>
      <option>Familia Yoseba</option>
      <option>Amigos Ana</option>
      <option>Amigos Yoseba</option>
    </select>

    <label class="form-label small fw-bold">2. Busca tu nombre</label>
    <select id="nombre" class="form-select mb-3" disabled required>
      <option value="">Selecciona primero el grupo</option>
    </select>

    <label class="form-label small fw-bold">3. Tel茅fono m贸vil</label>
    <input type="tel" id="telefono" class="form-control mb-3" 
       placeholder="Ej: 600000000" 
       pattern="[0-9]{9}" 
       maxlength="9" 
       required title="El tel茅fono debe tener 9 n煤meros">

    <label class="form-label small fw-bold">4. Dedicatoria (opcional)</label>
    <textarea id="mensaje" class="form-control mb-3" rows="3" placeholder="Escribe algo para los novios..."></textarea>

    <div class="row g-2">
      <div class="col-md-7">
        <button type="submit" id="btnConfirmar" class="btn btn-primary w-100 py-2">Confirmar asistencia</button>
      </div>
      <div class="col-md-5">
        <button type="button" id="btnNegar" class="btn btn-reject w-100 py-2">No podr茅 asistir</button>
      </div>
    </div>
  </form>
</div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx78dTFvM49q_HHtcMXqiCA2hLcEKO98xqNY-9fIAK-3owrvl1JlHuyGE1oD84RCIAw/exec'; // <--- ASEGRATE DE QUE SEA LA URL DE TU LTIMA IMPLEMENTACIN
  let invitados = [];

  // 1. CARGA DE DATOS MEJORADA
  function cargarInvitados() {
    const selectorNombre = document.getElementById('nombre');
    const selectorGrupo = document.getElementById('grupo');
    
    // Bloqueamos mientras carga
    selectorNombre.disabled = true;
    selectorNombre.innerHTML = '<option value="">Cargando lista...</option>';

    fetch(scriptURL)
      .then(res => res.json())
      .then(data => {
        invitados = data;
        console.log("Datos recibidos:", invitados);
        
        // Si el usuario ya seleccion贸 un grupo antes de que terminara de cargar,
        // forzamos la actualizaci贸n de los nombres ahora.
        if (selectorGrupo.value !== "") {
          actualizarNombres(selectorGrupo.value);
        } else {
          selectorNombre.innerHTML = '<option value="">Selecciona primero el grupo</option>';
        }
      })
      .catch(error => {
        console.error("Error:", error);
        selectorNombre.innerHTML = '<option value="">Error al conectar con Excel</option>';
      });
  }

  // 2. FUNCIN PARA FILTRAR NOMBRES
  function actualizarNombres(grupoSeleccionado) {
    const selectorNombre = document.getElementById('nombre');
    selectorNombre.innerHTML = '<option value="">Selecciona tu nombre</option>';
    
    if (!grupoSeleccionado) {
      selectorNombre.disabled = true;
      return;
    }

    // Filtrado insensible a espacios extra
    const filtrados = invitados.filter(i => String(i.grupo).trim() === String(grupoSeleccionado).trim());

    if (filtrados.length > 0) {
      filtrados.forEach(i => {
        let opt = document.createElement('option');
        opt.value = i.nombre;
        opt.innerHTML = i.nombre;
        selectorNombre.appendChild(opt);
      });
      selectorNombre.disabled = false;
    } else {
      // Si invitados ya tiene datos pero no hay coincidencia
      if (invitados.length > 0) {
        selectorNombre.innerHTML = '<option value="">No hay nombres en este grupo</option>';
      } else {
        selectorNombre.innerHTML = '<option value="">Cargando datos...</option>';
      }
      selectorNombre.disabled = true;
    }
  }

  // 3. LISTENERS
  window.addEventListener('DOMContentLoaded', cargarInvitados);

  document.getElementById('grupo').addEventListener('change', function(e) {
    actualizarNombres(e.target.value);
  });

  // 4. FUNCIN DE ENVO (Mantenemos la l贸gica de S/NEGADO)
  function enviarFormulario(tipoAsistencia) {
    const nombre = document.getElementById('nombre').value;
    const telefono = document.getElementById('telefono').value;
    
    if(!nombre || !telefono) {
      alert("Por favor, selecciona tu nombre e introduce un tel茅fono.");
      return;
    }

    const btnConfirmar = document.getElementById('btnConfirmar');
    const btnNegar = document.getElementById('btnNegar');
    
    btnConfirmar.disabled = true;
    btnNegar.disabled = true;
    btnConfirmar.innerHTML = 'Enviando...';

    const params = new URLSearchParams({
      nombre: nombre,
      telefono: telefono,
      mensaje: document.getElementById('mensaje').value,
      asistencia: tipoAsistencia 
    });

    fetch(scriptURL + '?' + params.toString(), { method: 'POST' })
      .then(res => {
        alert(tipoAsistencia === 'S' ? '隆Gracias por confirmar!' : 'Gracias por avisarnos, te echaremos de menos.');
        location.reload();
      })
      .catch(error => {
        alert('Error al procesar. Int茅ntalo de nuevo.');
        btnConfirmar.disabled = false;
        btnNegar.disabled = false;
      });
  }

  document.getElementById('formConfirmacion').addEventListener('submit', e => {
    e.preventDefault();
    enviarFormulario('S');
  });

  document.getElementById('btnNegar').addEventListener('click', () => {
    enviarFormulario('NEGADO');
  });
</script>

<footer id="contacto" class="py-4 border-top">
  <div class="container text-center">
    <p class="mb-2">
      <a href="index.html" class="text-decoration-none text-muted mx-2">隆Bienvenidos!</a> |
      <a href="itinerario.html" class="text-decoration-none text-muted mx-2">El Gran D铆a</a> |
      <a href="confirmacion.html" class="text-decoration-none text-muted mx-2">Confirmaci贸n</a> |
      <a href="fotos.html" class="text-decoration-none text-muted mx-2">lbum</a> |
      <a href="agradecimiento.html" class="text-decoration-none text-muted mx-2">Agradecimiento</a> |
      <a href="novedades.html" class="text-decoration-none text-muted mx-2">ltimas Novedades</a>
    </p>

    <div class="small text-muted mb-2">漏 2026 Yoseba & Ana</div>

    <div class="small text-muted">
      <a href="mailto:anacarmonacordoba@gmail.com" class="text-decoration-none text-dark">anacarmonacordoba@gmail.com</a> |  692 260 215
    </div>

    <div class="small text-muted">
      <a href="mailto:garciapardoyoseba@gmail.com" class="text-decoration-none text-dark">garciapardoyoseba@gmail.com</a> |  611 459 193
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="main.js"></script>
<link rel="stylesheet" href="styles.css">
</body>
</html>